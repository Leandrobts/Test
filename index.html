<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sanity Test #1 — ArrayBuffer Transfer (NO FALSE POSITIVE)</title>
<style>
  body { font-family: monospace; background: #111; color: #eee; padding: 20px; }
  h2 { color: #0f0; }
  pre { background: #1e1e1e; padding: 16px; border-left: 3px solid #0f0; white-space: pre-wrap; }
  .ok    { color: #0f0; font-weight: bold; }
  .alert { color: #f44; font-weight: bold; }
  .info  { color: #aaa; }
  button { background: #0f0; color: #000; border: none; padding: 12px 28px; font-size: 15px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>
<h2>Sanity Test #1 — ArrayBuffer Leak via Cyclic postMessage</h2>
<pre>
Objetivo: verificar se o transfer de ArrayBuffer em objeto cíclico é spec-compliant.
✅ Modern browser (Chrome/Firefox/etc) → SANITY PASSED
❌ PS4 FW 13.04                  → VULNERABLE
</pre>

<button onclick="runSanity()">▶ RUN SANITY TEST #1</button>
<pre id="log">Aperte o botão...</pre>

<script>
var log = document.getElementById('log');
function line(cls, msg) { var s = document.createElement('span'); s.className = cls; s.textContent = msg + '\n'; log.appendChild(s); }
function info(m)  { line('info',  '[INFO]  ' + m); }
function ok(m)    { line('ok',    '✅ ' + m); }
function alert_(m){ line('alert', '❌ ' + m); }
function sep()    { line('info',  '─'.repeat(70)); }

function leakBuffer(buf) {
  return new Promise(resolve => {
    var cyclic = { buf: buf, self: null }; cyclic.self = cyclic;
    var prev = window.onmessage;
    window.onmessage = e => {
      if (!e.data?.buf) return;
      window.onmessage = prev;
      resolve(e.data.buf);
    };
    postMessage(cyclic, '*', [buf]);
  });
}

async function runSanity() {
  log.textContent = '';
  info('=== Sanity Test #1 — ArrayBuffer Transfer Compliance ===');
  sep();

  var secretBuf = new ArrayBuffer(256);
  var view = new Uint32Array(secretBuf);
  view[0] = 0xDEADC0DE; view[1] = 0xCAFEBABE; view[2] = 0x13371337; view[3] = 0xBEEFBEEF;

  info('Buffer secreto criado (256 bytes)');
  var leakedBuf = await leakBuffer(secretBuf);

  info('Sender após transfer: byteLength = ' + secretBuf.byteLength);

  if (leakedBuf && leakedBuf.byteLength > 0) {
    sep();
    alert_('VULNERABILITY CONFIRMED');
    alert_('Receiver recebeu cópia VIVA do ArrayBuffer!');
    alert_('→ PS4 FW 13.04 é vulnerável (CWE-668)');
  } else {
    sep();
    ok('SANITY PASSED');
    ok('Receiver recebeu buffer neutered (byteLength = 0)');
    ok('Comportamento 100% conforme HTML Living Standard §2.7.5');
    ok('NENHUM falso positivo neste sistema');
  }
  sep();
  info('Teste finalizado. Rode também no Chrome/Firefox para confirmar.');
}
</script>
</body>
</html>
