<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS4 Fullscreen Blur + document.write Teardown Test</title>
</head>
<body>

<h1>Teardown Audit â€“ START + Blur + document.write</h1>
<button onclick="start()">START</button>
<pre id="log"></pre>

<script>
const log = m => document.getElementById("log").textContent += m + "\n";

let arr;
let bufferRef;

function dump(tag) {
    log("=== " + tag + " ===");
    log("length: " + arr.length);
    log("byteLength: " + arr.byteLength);
    log("buffer same: " + (arr.buffer === bufferRef));
    for (let i = 0; i < arr.length; i++) {
        log("[" + i + "] = " + arr[i]);
    }
}

function start() {
    log("[*] START pressed");

    arr = new Float64Array(8);
    for (let i = 0; i < arr.length; i++) {
        arr[i] = 0xBEEF + i;
    }
    bufferRef = arr.buffer;

    dump("INITIAL");

    const el = document.documentElement;
    if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();

    window.onblur = () => {
        log("");
        log("[!] BLUR detected");

        dump("PRE-document.write");

        log("[*] Triggering document.write teardown");

        document.open();
        document.write("<html><body><h1>Teardown</h1></body></html>");
        document.close();
    };
}
</script>

</body>
</html>
