<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEST 04 - Canvas 2D Extreme Load</title>
</head>
<body>

<h2>TEST 04 - Canvas 2D Extreme Load</h2>
<p>Alvo: crash via getImageData/putImageData loop + canvas resize + pixel manipulation</p>
<p>API: Canvas 2D Context, ImageData, createImageData</p>
<p>Tecnica: leitura/escrita massiva de pixel buffer + resize dinamico de canvas</p>

<canvas id="c" width="1920" height="1080"></canvas>
<pre id="log">Aguardando inicio...</pre>
<button onclick="startTest()">INICIAR TESTE</button>
<button onclick="testOversized()">CANVAS OVERSIZED</button>

<script>
var log = document.getElementById('log');
var canvas = document.getElementById('c');
var ctx = canvas.getContext('2d');

function append(msg) {
  log.textContent += '\n' + msg;
}

function startTest() {
  append('[04] Canvas 2D stress test iniciado...');
  append('[04] Canvas: ' + canvas.width + 'x' + canvas.height);

  var round = 0;

  function stressRound() {
    try {
      var w = canvas.width;
      var h = canvas.height;

      // Ler todo o canvas como ImageData (1920*1080*4 = ~8MB por leitura)
      var imgData = ctx.getImageData(0, 0, w, h);

      // Manipulacao bit a bit em todo o buffer
      var data = imgData.data;
      for (var i = 0; i < data.length; i += 4) {
        data[i]     = (i >> 2) & 0xFF;       // R
        data[i + 1] = (i >> 2 >> 8) & 0xFF;  // G
        data[i + 2] = round & 0xFF;           // B
        data[i + 3] = 255;                    // A
      }

      // Escrever de volta
      ctx.putImageData(imgData, 0, 0);

      // Operacoes adicionais de compositing
      ctx.globalCompositeOperation = 'xor';
      ctx.fillRect(0, 0, w, h);
      ctx.globalCompositeOperation = 'source-over';

      // Criar novo ImageData separado e mesclar
      var img2 = ctx.createImageData(w, h);
      for (var j = 0; j < img2.data.length; j++) {
        img2.data[j] = data[img2.data.length - 1 - j];
      }
      ctx.putImageData(img2, 0, 0);

      round++;
      append('[04] Round ' + round + ' completo | Buffer: ' + data.length + ' bytes');

      if (round < 200) {
        setTimeout(stressRound, 0);
      } else {
        append('[04] 200 rounds OK. Iniciando resize loop...');
        resizeLoop();
      }
    } catch(e) {
      append('[04] EXCECAO em round ' + round + ': ' + e.message);
    }
  }

  stressRound();
}

function resizeLoop() {
  // Resize canvas dinamicamente forca realloc do backing store
  var sizes = [
    [3840, 2160], // 4K
    [1, 1],
    [4096, 4096], // 64MB backing store
    [7680, 4320], // 8K - provavelmente excede limite
    [1920, 1080],
    [8192, 8192], // ~256MB backing store
    [16384, 16384], // potencialmente OOM
  ];

  var idx = 0;

  function doResize() {
    if (idx >= sizes.length) {
      append('[04] Resize loop completo. SE NAO CRASHOU: tentar testOversized()');
      return;
    }

    try {
      canvas.width = sizes[idx][0];
      canvas.height = sizes[idx][1];

      // Recapturar contexto e fazer operacao imediatamente apos resize
      var c = canvas.getContext('2d');
      c.fillRect(0, 0, canvas.width, canvas.height);
      var d = c.getImageData(0, 0, canvas.width, canvas.height);

      append('[04] Resize ' + canvas.width + 'x' + canvas.height + ' | ImageData: ' + d.data.byteLength + ' bytes');
      idx++;
      setTimeout(doResize, 100);
    } catch(e) {
      append('[04] Resize excecao para ' + sizes[idx] + ': ' + e.message);
      idx++;
      setTimeout(doResize, 100);
    }
  }

  doResize();
}

function testOversized() {
  // Tentar criar canvas extremamente grande para OOM
  append('[04] Testando canvas oversized...');
  var sizes = [32768, 65536, 131072];

  for (var i = 0; i < sizes.length; i++) {
    try {
      var offscreen = document.createElement('canvas');
      offscreen.width = sizes[i];
      offscreen.height = sizes[i];
      var c2 = offscreen.getContext('2d');
      c2.fillRect(0, 0, 100, 100);
      var imgd = c2.getImageData(0, 0, sizes[i], sizes[i]);
      append('[04] Canvas ' + sizes[i] + 'x' + sizes[i] + ': OK | ' + imgd.data.byteLength + ' bytes');
    } catch(e) {
      append('[04] Canvas ' + sizes[i] + 'x' + sizes[i] + ': EXCECAO - ' + e.message);
    }
  }
}
</script>

</body>
</html>
