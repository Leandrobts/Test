<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEST 05 - Web Worker OOM Flood</title>
</head>
<body>

<h2>TEST 05 - Web Worker OOM Flood</h2>
<p>Alvo: crash/OOM via criacao massiva de Web Workers + transferencia de ArrayBuffers</p>
<p>API: Worker, Blob URL, postMessage, ArrayBuffer transfer</p>
<p>Tecnica: cada worker recebe ArrayBuffer transferido + faz alocacao pesada internamente</p>

<pre id="log">Aguardando inicio...</pre>
<button onclick="startBasic()">TESTE BASICO (50 workers)</button>
<button onclick="startHeavy()">TESTE PESADO (transferable + memoria)</button>
<button onclick="startFlood()">FLOOD (criar/destruir rapido)</button>

<script>
var log = document.getElementById('log');
var workers = [];

function append(msg) {
  log.textContent += '\n' + msg;
}

// Worker code inline via Blob
var workerCode = [
  'self.onmessage = function(e) {',
  '  var buf = e.data.buffer;',       // received transferred buffer
  '  var size = e.data.size || 1024 * 1024 * 32;', // 32MB default
  '  try {',
  '    // Allocate large array inside worker thread',
  '    var arr = new Float64Array(size);',
  '    for (var i = 0; i < arr.length; i += 1024) {',
  '      arr[i] = Math.random();',    // touch pages
  '    }',
  '    // Send back a large buffer (transfers ownership)',
  '    var out = new ArrayBuffer(size * 4);',
  '    self.postMessage({status:"ok", len: arr.length}, [out]);',
  '  } catch(ex) {',
  '    self.postMessage({status:"error", msg: ex.message});',
  '  }',
  '};'
].join('\n');

function makeWorker() {
  var blob = new Blob([workerCode], {type: 'application/javascript'});
  var url = URL.createObjectURL(blob);
  var w = new Worker(url);
  URL.revokeObjectURL(url);
  return w;
}

function startBasic() {
  append('[05] Criando 50 workers basicos...');
  for (var i = 0; i < 50; i++) {
    try {
      var w = makeWorker();
      workers.push(w);
      var buf = new ArrayBuffer(1024 * 1024 * 16); // 16MB each
      var idx = i;
      (function(worker, index) {
        worker.onmessage = function(e) {
          append('[05] Worker ' + index + ': ' + JSON.stringify(e.data));
        };
        worker.onerror = function(e) {
          append('[05] Worker ' + index + ' ERROR: ' + e.message);
        };
        worker.postMessage({buffer: buf, size: 4 * 1024 * 1024}, [buf]);
      })(w, idx);
    } catch(e) {
      append('[05] Falha ao criar worker ' + i + ': ' + e.message);
    }
  }
  append('[05] 50 workers disparados. Total: ' + workers.length);
}

function startHeavy() {
  append('[05] Modo pesado: workers com 128MB cada...');
  var count = 0;

  function spawnHeavy() {
    try {
      var w = makeWorker();
      workers.push(w);
      var buf = new ArrayBuffer(1024 * 1024 * 128); // 128MB transferred
      var touch = new Uint8Array(buf);
      // Touch all pages before transfer to force physical allocation
      for (var i = 0; i < touch.length; i += 4096) {
        touch[i] = count & 0xFF;
      }

      w.onmessage = function(e) {
        append('[05] Heavy worker ' + count + ': ' + e.data.status + ' | len=' + e.data.len);
        if (count < 20) {
          count++;
          setTimeout(spawnHeavy, 200);
        }
      };
      w.onerror = function(e) {
        append('[05] Heavy worker ' + count + ' ERRO: ' + e.message);
        count++;
        if (count < 20) setTimeout(spawnHeavy, 200);
      };

      w.postMessage({buffer: buf, size: 16 * 1024 * 1024}, [buf]);
      append('[05] Heavy worker ' + count + ' enviado com 128MB');

    } catch(e) {
      append('[05] spawnHeavy excecao: ' + e.message);
    }
  }

  spawnHeavy();
}

function startFlood() {
  append('[05] Worker flood: criar e destruir rapidamente para pressionar alocador...');
  var created = 0;
  var terminated = 0;

  function flood() {
    try {
      for (var i = 0; i < 10; i++) {
        var w = makeWorker();
        var buf = new ArrayBuffer(1024 * 1024 * 8); // 8MB
        w.postMessage({buffer: buf, size: 2 * 1024 * 1024}, [buf]);
        // Terminate immediately without waiting for response
        w.terminate();
        terminated++;
      }
      created += 10;
      append('[05] Flood: criados=' + created + ' terminados=' + terminated);

      if (created < 2000) {
        setTimeout(flood, 50);
      }
    } catch(e) {
      append('[05] Flood excecao em created=' + created + ': ' + e.message);
    }
  }

  flood();
}
</script>

</body>
</html>
