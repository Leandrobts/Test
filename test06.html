<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TEST 06 - DOM Tree Recursive Bomb</title>
</head>
<body>

<h2>TEST 06 - DOM Tree Recursive Bomb</h2>
<p>Alvo: stack overflow / crash via DOM tree manipulation extrema</p>
<p>API: createElement, appendChild, insertBefore, cloneNode, innerHTML</p>
<p>Tecnica: arvore DOM profunda + clonagem de arvore grande + innerHTML recursivo</p>

<div id="target"></div>
<pre id="log">Aguardando inicio...</pre>
<button onclick="testDeepTree()">ARVORE PROFUNDA</button>
<button onclick="testWideTree()">ARVORE LARGA</button>
<button onclick="testCloneBomb()">CLONE BOMB</button>
<button onclick="testInnerHTML()">innerHTML RECURSIVO</button>

<script>
var log = document.getElementById('log');
var target = document.getElementById('target');

function append(msg) {
  log.textContent += '\n' + msg;
}

function testDeepTree() {
  append('[06] Criando arvore DOM extremamente profunda...');
  target.innerHTML = '';

  try {
    // Criar arvore com profundidade de 100.000 nos
    var current = target;
    var depth = 0;
    var MAX_DEPTH = 100000;

    for (depth = 0; depth < MAX_DEPTH; depth++) {
      var child = document.createElement('div');
      child.setAttribute('data-depth', depth);
      current.appendChild(child);
      current = child;

      if (depth % 10000 === 0) {
        append('[06] Profundidade: ' + depth);
      }
    }

    append('[06] Arvore criada com profundidade ' + depth);

    // Agora tentar clonar - forca recursao no motor
    var clone = target.cloneNode(true);
    append('[06] cloneNode(true) em arvore de depth ' + depth + ': OK');

    // Serializar para string - forca recursao do serializador
    var html = target.innerHTML;
    append('[06] innerHTML.length: ' + html.length);

  } catch(e) {
    append('[06] Deep tree EXCECAO em depth=' + depth + ': ' + e.message);
  }
}

function testWideTree() {
  append('[06] Criando arvore DOM extremamente larga...');
  target.innerHTML = '';

  try {
    var frag = document.createDocumentFragment();
    var CHILD_COUNT = 500000;

    for (var i = 0; i < CHILD_COUNT; i++) {
      var el = document.createElement('span');
      el.textContent = i;
      el.setAttribute('data-id', i);
      el.setAttribute('class', 'item-' + (i % 100));
      frag.appendChild(el);

      if (i % 50000 === 0) {
        append('[06] Elementos criados: ' + i);
      }
    }

    append('[06] Inserindo fragmento com ' + CHILD_COUNT + ' filhos no DOM...');
    target.appendChild(frag);
    append('[06] target.childElementCount: ' + target.childElementCount);

    // Query em arvore gigante
    append('[06] querySelectorAll em arvore larga...');
    var nodes = target.querySelectorAll('.item-50');
    append('[06] querySelectorAll resultado: ' + nodes.length + ' nos');

  } catch(e) {
    append('[06] Wide tree EXCECAO: ' + e.message);
  }
}

function testCloneBomb() {
  append('[06] Clone bomb: duplicar arvore exponencialmente...');
  target.innerHTML = '<div class="root"><span>SEED</span></div>';

  try {
    var root = target.firstChild;

    // Cada iteracao dobra o tamanho da arvore
    for (var i = 0; i < 25; i++) {
      var clone = root.cloneNode(true);
      root.appendChild(clone);

      var count = root.querySelectorAll('*').length;
      append('[06] Clone bomb iteracao ' + i + ': ~' + count + ' nos no DOM');

      if (count > 10000000) {
        append('[06] Limite de 10M nos atingido - forcar innerHTML serialize...');
        var s = root.innerHTML;
        append('[06] innerHTML serializado: ' + s.length + ' chars');
        break;
      }
    }
  } catch(e) {
    append('[06] Clone bomb EXCECAO: ' + e.message);
  }
}

function testInnerHTML() {
  append('[06] innerHTML recursivo: construindo string gigante...');

  try {
    // Construir HTML fortemente aninhado como string e injetar
    var DEPTH = 50000;
    var open = '';
    var close = '';

    for (var i = 0; i < DEPTH; i++) {
      open += '<div id="d' + i + '">';
      close = '</div>' + close;
    }

    var html = open + 'CENTRO' + close;
    append('[06] String HTML gerada: ' + html.length + ' chars | depth=' + DEPTH);

    target.innerHTML = html;
    append('[06] innerHTML setado. Lendo de volta...');

    var out = target.innerHTML;
    append('[06] innerHTML lido de volta: ' + out.length + ' chars');

    // Navegar ate o no mais profundo via JS
    var node = target;
    var depth = 0;
    while (node.firstChild) {
      node = node.firstChild;
      depth++;
    }
    append('[06] No mais profundo encontrado em depth=' + depth);

  } catch(e) {
    append('[06] innerHTML recursivo EXCECAO: ' + e.message);
  }
}
</script>

</body>
</html>
