<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>TEST 19 - Storage Boundary Abuse</title></head>
<body>
<h2>TEST 19 - localStorage / sessionStorage Boundary Abuse</h2>
<p>Alvo: crash / info leak via manipulacao de borda do armazenamento local</p>
<p>API: localStorage, sessionStorage, StorageEvent</p>
<p>Tecnica: testar limites de chave/valor, caracteres especiais (null byte, surrogate pairs,
BOM), modificar storage durante iteracao, e race condition com StorageEvent.
O PS4 tem quota de storage menor que browsers desktop - overflow pode crashar.</p>

<pre id="log">Aguardando...</pre>
<button onclick="checkStorage()">CHECAR STORAGE</button>
<button onclick="testKeyEdgeCases()">EDGE CASES DE CHAVE</button>
<button onclick="testValueBoundary()">LIMITE DE VALOR</button>
<button onclick="testStorageIteration()">ITERACAO + MUTACAO</button>
<button onclick="testStorageEvent()">STORAGE EVENT</button>

<script>
var log = document.getElementById('log');
function append(msg) { log.textContent += '\n' + msg; }

function checkStorage() {
  append('[19] Verificando suporte a Storage...');
  append('[19] localStorage: ' + (typeof localStorage !== 'undefined' ? 'PRESENTE' : 'AUSENTE'));
  append('[19] sessionStorage: ' + (typeof sessionStorage !== 'undefined' ? 'PRESENTE' : 'AUSENTE'));
  if (typeof localStorage !== 'undefined') {
    append('[19] localStorage.length atual: ' + localStorage.length);
  }
}

function testKeyEdgeCases() {
  append('[19] Edge cases de chave...');
  if (typeof localStorage === 'undefined') { append('[19] localStorage ausente'); return; }

  var edgeCases = [
    { key: '',                   label: 'chave vazia' },
    { key: '\u0000',             label: 'null byte' },
    { key: '\uFFFF',             label: 'U+FFFF' },
    { key: '\uD800\uDC00',       label: 'surrogate pair (emoji base)' },
    { key: '\uD800',             label: 'lone high surrogate' },
    { key: '\uDFFF',             label: 'lone low surrogate' },
    { key: '\uFEFF',             label: 'BOM (zero-width no-break space)' },
    { key: 'a'.repeat(65536),    label: 'chave 64KB' },
    { key: '\n\r\t',             label: 'whitespace chars' },
    { key: '__proto__',          label: '__proto__ como chave' },
    { key: 'constructor',        label: 'constructor como chave' },
    { key: 'length',             label: 'length como chave' },
    { key: JSON.stringify({a:1}),label: 'JSON como chave' },
  ];

  for (var i = 0; i < edgeCases.length; i++) {
    var ec = edgeCases[i];
    try {
      localStorage.setItem(ec.key, 'test_value_' + i);
      var got = localStorage.getItem(ec.key);
      var match = got === 'test_value_' + i;
      append('[19] ' + ec.label + ': set/get ' + (match ? 'OK' : 'MISMATCH: got=' + got));
      localStorage.removeItem(ec.key);
    } catch(e) {
      append('[19] ' + ec.label + ' EXCECAO: ' + e.message);
    }
  }
}

function testValueBoundary() {
  append('[19] Teste de limite de valor no localStorage...');
  if (typeof localStorage === 'undefined') { append('[19] localStorage ausente'); return; }

  // Construir string crescente ate falhar (quota exceeded)
  var SIZE_KB = [1, 10, 100, 500, 1024, 2048, 4096];

  for (var i = 0; i < SIZE_KB.length; i++) {
    var size = SIZE_KB[i] * 1024;
    try {
      var val = 'X'.repeat(size);
      localStorage.setItem('boundary_test', val);
      var readBack = localStorage.getItem('boundary_test');
      var preserved = readBack && readBack.length === size;
      append('[19] ' + SIZE_KB[i] + 'KB: ' + (preserved ? 'OK' : 'TRUNCADO: len=' + (readBack ? readBack.length : 'null')));
      localStorage.removeItem('boundary_test');
    } catch(e) {
      append('[19] ' + SIZE_KB[i] + 'KB: EXCECAO - ' + e.message);
      break;
    }
  }

  // Valores especiais
  var specialValues = [
    { val: null,      label: 'null' },
    { val: undefined, label: 'undefined' },
    { val: NaN,       label: 'NaN' },
    { val: Infinity,  label: 'Infinity' },
    { val: -0,        label: '-0' },
    { val: {},        label: 'object {}' },
    { val: [],        label: 'array []' },
    { val: function(){}, label: 'function' },
  ];

  for (var j = 0; j < specialValues.length; j++) {
    try {
      localStorage.setItem('special_' + j, specialValues[j].val);
      var sv = localStorage.getItem('special_' + j);
      append('[19] Valor ' + specialValues[j].label + ': armazenado como "' + sv + '"');
      localStorage.removeItem('special_' + j);
    } catch(e) {
      append('[19] Valor ' + specialValues[j].label + ' EXCECAO: ' + e.message);
    }
  }
}

function testStorageIteration() {
  append('[19] Iteracao de localStorage com mutacao durante o loop...');
  if (typeof localStorage === 'undefined') { append('[19] localStorage ausente'); return; }

  // Popular com 100 itens
  localStorage.clear();
  for (var i = 0; i < 100; i++) {
    localStorage.setItem('iter_' + i, 'val_' + i);
  }
  append('[19] 100 itens criados. length=' + localStorage.length);

  // Iterar por indice (forma antiga)
  var visited = [];
  var mutations = 0;

  for (var k = 0; k < localStorage.length; k++) {
    var key = localStorage.key(k);
    if (key === null) {
      append('[19] localStorage.key(' + k + ') retornou null! length=' + localStorage.length);
      break;
    }
    visited.push(key);

    // Mutacao durante iteracao
    if (k === 20) {
      // Adicionar novos itens durante iteracao
      for (var n = 100; n < 150; n++) {
        localStorage.setItem('new_' + n, 'injected');
      }
      mutations++;
      append('[19] 50 itens adicionados durante iteracao em k=20. Novo length=' + localStorage.length);
    }

    if (k === 50) {
      // Remover itens durante iteracao
      for (var m = 0; m < 10; m++) {
        localStorage.removeItem('iter_' + m);
      }
      mutations++;
      append('[19] 10 itens removidos durante iteracao em k=50. Novo length=' + localStorage.length);
    }
  }

  append('[19] Iteracao completa: visited=' + visited.length + ' | mutations=' + mutations);
  append('[19] localStorage.length final=' + localStorage.length);
  localStorage.clear();
}

function testStorageEvent() {
  append('[19] StorageEvent: disparar evento manualmente...');
  if (typeof localStorage === 'undefined') { append('[19] localStorage ausente'); return; }

  var eventsReceived = [];

  // StorageEvent e disparado quando OUTRA janela muda o storage
  // Mas podemos tentar criar um StorageEvent sintetico
  window.addEventListener('storage', function(e) {
    eventsReceived.push({
      key: e.key,
      oldValue: e.oldValue,
      newValue: e.newValue,
      url: e.url
    });
    append('[19] StorageEvent recebido: key=' + e.key + ' | old=' + e.oldValue + ' | new=' + e.newValue);
  });

  // Tentar criar StorageEvent via constructor
  try {
    var evt = new StorageEvent('storage', {
      key: 'injected_key',
      oldValue: null,
      newValue: 'injected_value',
      url: window.location.href,
      storageArea: localStorage
    });
    window.dispatchEvent(evt);
    append('[19] StorageEvent sintetico disparado via constructor');
    append('[19] eventsReceived: ' + eventsReceived.length);
  } catch(e) {
    append('[19] StorageEvent constructor EXCECAO: ' + e.message);
  }

  // Tentar criar via createEvent (forma antiga)
  try {
    var evt2 = document.createEvent('StorageEvent');
    evt2.initStorageEvent('storage', false, false, 'old_key', 'old', 'new', location.href, localStorage);
    window.dispatchEvent(evt2);
    append('[19] StorageEvent via createEvent/initStorageEvent disparado');
  } catch(e) {
    append('[19] createEvent/initStorageEvent EXCECAO: ' + e.message);
  }

  // Modificar storageArea de um StorageEvent apos criacao
  try {
    var evt3 = new StorageEvent('storage', {
      key: 'test',
      newValue: 'val',
      storageArea: sessionStorage // usar sessionStorage em vez de localStorage
    });
    // Tentar mudar storageArea (readonly por spec, mas...)
    try {
      evt3.storageArea = localStorage;
      append('[19] storageArea modificado para localStorage (deveria ser readonly)');
    } catch(re) {
      append('[19] storageArea readonly: ' + re.message);
    }
    append('[19] evt3.storageArea === sessionStorage: ' + (evt3.storageArea === sessionStorage));
    append('[19] evt3.storageArea === localStorage: ' + (evt3.storageArea === localStorage));
  } catch(e) {
    append('[19] storageArea test EXCECAO: ' + e.message);
  }

  setTimeout(function() {
    append('[19] Total events recebidos: ' + eventsReceived.length);
  }, 1000);
}
</script>
</body>
</html>
